#!/bin/bash
set -e

NODE_MANAGER="{{ .node_manager }}"

echo "==> Setting up Node.js environment (manager: $NODE_MANAGER)..."

# Detect Homebrew prefix
OS="$(uname -s)"
ARCH="$(uname -m)"
if [ "$OS" = "Darwin" ]; then
    [ "$ARCH" = "arm64" ] && HOMEBREW_PREFIX="/opt/homebrew" || HOMEBREW_PREFIX="/usr/local"
else
    HOMEBREW_PREFIX="/home/linuxbrew/.linuxbrew"
fi

# Ensure brew is in PATH
eval "$($HOMEBREW_PREFIX/bin/brew shellenv)"

# Install and configure based on selected node manager
case "$NODE_MANAGER" in
    mise)
        echo "==> Installing Node.js and Yarn with mise..."
        if command -v mise &> /dev/null; then
            mise install node@20.9.0
            mise install yarn@latest
            mise use --global node@20.9.0
            mise use --global yarn@latest
        fi
        ;;

    volta)
        echo "==> Installing Volta..."
        if ! command -v volta &> /dev/null; then
            curl https://get.volta.sh | bash -s -- --skip-setup
        fi
        export VOLTA_HOME="$HOME/.volta"
        export PATH="$VOLTA_HOME/bin:$PATH"

        echo "==> Installing Node.js and Yarn with Volta..."
        volta install node@20
        volta install yarn
        ;;

    nvm)
        echo "==> Installing nvm..."
        if [ ! -d "$HOME/.nvm" ]; then
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
        fi
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

        echo "==> Installing Node.js with nvm..."
        nvm install 20
        nvm use 20
        nvm alias default 20

        # Install yarn globally
        npm install -g yarn
        ;;

    none)
        echo "==> Skipping Node.js manager installation"
        echo "    You can install Node.js manually later"
        ;;
esac

# Install global npm packages (for Neovim LSPs) - only if npm is available
if command -v npm &> /dev/null; then
    echo "==> Installing LSPs and formatters..."
    npm install -g typescript
    npm install -g typescript-language-server
    npm install -g @fsouza/prettierd
    npm install -g eslint_d
    npm install -g vscode-langservers-extracted
else
    echo "==> npm not found, skipping LSP installation"
    echo "    Run this manually after installing Node.js:"
    echo "    npm install -g typescript typescript-language-server @fsouza/prettierd eslint_d vscode-langservers-extracted"
fi

echo "==> Node.js setup complete!"
